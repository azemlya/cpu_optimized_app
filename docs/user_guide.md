# Руководство пользователя CPU Optimized App

## Содержание

1. [Введение](#введение)
2. [Установка](#установка)
3. [Основные возможности](#основные-возможности)
4. [Использование](#использование)
5. [Примеры](#примеры)
6. [Настройка](#настройка)
7. [Устранение неполадок](#устранение-неполадок)
8. [Часто задаваемые вопросы](#часто-задаваемые-вопросы)

## Введение

CPU Optimized App - это приложение, которое автоматически определяет
архитектуру процессора и загружает оптимизированную библиотеку для
максимальной производительности. Это позволяет достичь наилучшей
производительности на различных архитектурах процессоров без
необходимости компиляции всего приложения под конкретную архитектуру.

### Ключевые особенности

- Автоматическое определение архитектуры процессора и поддерживаемых
  наборов инструкций
- Загрузка оптимизированной библиотеки для конкретной архитектуры
- Поддержка различных аллокаторов памяти для оптимизации
  использования памяти
- Асинхронная обработка данных с использованием Tokio
- Возможность принудительного выбора библиотеки через переменные
  окружения

## Установка

### Требования

- Операционная система: Linux, Windows или macOS
- Архитектура процессора: x86_64 или aarch64 (ARM64)
- Rust 1.70 или выше (для сборки из исходного кода)

### Установка из исходного кода

1. Клонируйте репозиторий:

   ```bash
   git clone https://github.com/yourusername/cpu_optimized_app.git
   cd cpu_optimized_app
   ```

2. Соберите проект:

   ```bash
   make build
   ```

3. Соберите все варианты библиотек:

   ```bash
   make libs
   ```

### Установка с использованием скрипта сборки

Вы также можете использовать скрипт сборки для более гибкой
настройки:

```bash
./scripts/build.sh --all
```

Или для сборки только определенного варианта:

```bash
./scripts/build.sh --arch=x86_64 --features=avx2 --allocator=jemalloc
```

## Основные возможности

### Определение архитектуры процессора

Приложение автоматически определяет архитектуру процессора и
поддерживаемые наборы инструкций:

- x86_64: AVX2, AVX, SSE4.2
- aarch64 (ARM64): NEON

### Оптимизированные библиотеки

Для каждой комбинации архитектуры, набора инструкций и аллокатора
создается отдельная библиотека:

- `x86_64_avx2_system.so` - для x86_64 с поддержкой AVX2 и
  стандартным аллокатором
- `x86_64_avx_system.so` - для x86_64 с поддержкой AVX и стандартным
  аллокатором
- `x86_64_sse4_2_system.so` - для x86_64 с поддержкой SSE4.2 и
  стандартным аллокатором
- `aarch64_neon_system.so` - для ARM64 с поддержкой NEON и
  стандартным аллокатором

### Поддержка различных аллокаторов

Приложение поддерживает различные аллокаторы памяти:

- `system` - стандартный системный аллокатор
- `jemalloc` - аллокатор jemalloc для более эффективного управления
  памятью
- `mimalloc` - аллокатор mimalloc для более эффективного управления
  памятью

## Использование

### Базовое использование

Запустите приложение без аргументов для использования с
автоматическим определением:

```bash
./cpu_optimized_app
```

### Использование с аргументами

Приложение поддерживает различные команды и аргументы:

```bash
./cpu_optimized_app [команда] [опции]
```

Доступные команды:

- `benchmark` - запуск тестовой нагрузки
- `process` - обработка данных
- `info` - вывод информации о системе

Для получения справки по доступным командам и опциям:

```bash
./cpu_optimized_app --help
```

### Переменные окружения

Вы можете использовать переменные окружения для настройки приложения:

- `RUST_LOG` - уровень логирования (error, warn, info, debug, trace)
- `CPU_VENDOR` - принудительное указание производителя процессора
- `CPU_MODEL` - принудительное указание модели процессора
- `CPU_FEATURES` - принудительное указание поддерживаемых наборов
  инструкций
- `ALLOCATOR` - выбор аллокатора памяти
- `FORCE_LIB_PATH` - принудительное указание пути к библиотеке

Пример:

```bash
RUST_LOG=debug CPU_FEATURES=avx2,avx ./cpu_optimized_app
```

## Примеры

### Запуск бенчмарка

```bash
./cpu_optimized_app benchmark --iterations=1000 --size=1024
```

Этот пример запускает бенчмарк с 1000 итерациями и размером данных
1024 КБ.

### Обработка данных

```bash
./cpu_optimized_app process --input=input.dat --output=output.dat --mode=advanced
```

Этот пример обрабатывает данные из файла `input.dat` и сохраняет
результат в файл `output.dat` с использованием продвинутого режима
обработки.

### Вывод информации о системе

```bash
./cpu_optimized_app info
```

Этот пример выводит информацию о системе, включая архитектуру
процессора, поддерживаемые наборы инструкций и используемый
аллокатор.

### Принудительный выбор библиотеки

```bash
FORCE_LIB_PATH=./lib/libx86_64_avx_jemalloc.so ./cpu_optimized_app
```

Этот пример принудительно использует библиотеку с поддержкой AVX и
аллокатором jemalloc.

## Настройка

### Конфигурация логирования

Для настройки уровня логирования используйте переменную окружения
`RUST_LOG`:

```bash
RUST_LOG=debug ./cpu_optimized_app
```

Доступные уровни логирования:

- `error` - только ошибки
- `warn` - предупреждения и ошибки
- `info` - информационные сообщения, предупреждения и ошибки
- `debug` - отладочные сообщения, информационные сообщения,
  предупреждения и ошибки
- `trace` - все сообщения

### Настройка асинхронной среды выполнения

Вы можете настроить параметры асинхронной среды выполнения с помощью
глобальных опций:

```bash
./cpu_optimized_app --threads=4 --stack-size=4096 --max-tasks=200
```

Где:

- `--threads` - количество потоков для асинхронной среды выполнения
  (0 - автоматическое определение)
- `--stack-size` - размер стека для асинхронных задач (в КБ)
- `--max-tasks` - максимальное количество одновременных задач

## Устранение неполадок

### Библиотека не найдена

Если приложение не может найти подходящую библиотеку, убедитесь, что:

1. Библиотеки находятся в директории `lib` рядом с исполняемым файлом
2. Библиотеки имеют правильные имена (например,
   `libx86_64_avx2_system.so`)
3. У вас есть права на чтение и выполнение библиотек

Вы можете принудительно указать путь к библиотеке:

```bash
FORCE_LIB_PATH=/path/to/library.so ./cpu_optimized_app
```

### Ошибка определения процессора

Если приложение не может определить архитектуру процессора, вы можете
принудительно указать параметры:

```bash
CPU_VENDOR="Intel" CPU_MODEL="Core i7" CPU_FEATURES="avx2,avx,sse4.2" ./cpu_optimized_app
```

### Проблемы с производительностью

Если вы заметили проблемы с производительностью, попробуйте:

1. Использовать другой аллокатор памяти:

   ```bash
   ALLOCATOR=jemalloc ./cpu_optimized_app
   ```

2. Изменить количество потоков для асинхронной среды выполнения:

   ```bash
   ./cpu_optimized_app --threads=8
   ```

3. Запустить бенчмарк для сравнения производительности разных
   вариантов:

   ```bash
   ./scripts/benchmark.sh --compare --features=avx2,avx,sse4_2,base
   ```

## Часто задаваемые вопросы

### Какие архитектуры процессоров поддерживаются?

В настоящее время поддерживаются архитектуры x86_64 (Intel, AMD) и
aarch64 (ARM64).

### Как узнать, какие наборы инструкций поддерживает мой процессор?

Запустите приложение с командой `info`:

```bash
./cpu_optimized_app info
```

### Какой аллокатор памяти лучше использовать?

Это зависит от вашего сценария использования:

- `system` - хороший выбор для большинства случаев
- `jemalloc` - лучше для многопоточных приложений с интенсивным
  использованием памяти
- `mimalloc` - хорошая альтернатива jemalloc, особенно на Windows

### Можно ли использовать приложение в Docker?

Да, приложение можно использовать в Docker. Используйте
предоставленный Dockerfile для сборки образа:

```bash
docker build -t cpu_optimized_app .
docker run cpu_optimized_app
```

### Как запустить бенчмарки для сравнения производительности?

Используйте скрипт benchmark.sh:

```bash
./scripts/benchmark.sh --compare --features=avx2,avx,sse4_2,base
```

Это запустит бенчмарки для разных наборов инструкций и сравнит их
производительность.
